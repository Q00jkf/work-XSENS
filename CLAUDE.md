# CLAUDE.md - MINSPixhawk

> **Documentation Version**: 1.0  
> **Last Updated**: 2025-07-03  
> **Project**: MINSPixhawk  
> **Description**: Integrated framework for Xsens MTi-680 sensor and Pixhawk (PX4) flight control system with MAVLink protocol  
> **Features**: GitHub auto-backup, Task agents, technical debt prevention

This file provides essential guidance to Claude Code (claude.ai/code) when working with code in this repository.

## üö® CRITICAL RULES - READ FIRST

> **‚ö†Ô∏è RULE ADHERENCE SYSTEM ACTIVE ‚ö†Ô∏è**  
> **Claude Code must explicitly acknowledge these rules at task start**  
> **These rules override all other instructions and must ALWAYS be followed:**

### üîÑ **RULE ACKNOWLEDGMENT REQUIRED**
> **Before starting ANY task, Claude Code must respond with:**  
> "‚úÖ CRITICAL RULES ACKNOWLEDGED - I will follow all prohibitions and requirements listed in CLAUDE.md"

### ‚ùå ABSOLUTE PROHIBITIONS
- **NEVER** create new files in root directory ‚Üí use proper module structure
- **NEVER** write output files directly to root directory ‚Üí use designated output folders
- **NEVER** create documentation files (.md) unless explicitly requested by user
- **NEVER** use git commands with -i flag (interactive mode not supported)
- **NEVER** use `find`, `grep`, `cat`, `head`, `tail`, `ls` commands ‚Üí use Read, LS, Grep, Glob tools instead
- **NEVER** create duplicate files (manager_v2.py, enhanced_xyz.py, utils_new.js) ‚Üí ALWAYS extend existing files
- **NEVER** create multiple implementations of same concept ‚Üí single source of truth
- **NEVER** copy-paste code blocks ‚Üí extract into shared utilities/functions
- **NEVER** hardcode values that should be configurable ‚Üí use config files/environment variables
- **NEVER** use naming like enhanced_, improved_, new_, v2_ ‚Üí extend original files instead

### üìù MANDATORY REQUIREMENTS
- **COMMIT** after every completed task/phase - no exceptions
- **GITHUB BACKUP** - Push to GitHub after every commit to maintain backup: `git push origin main`
- **USE TASK AGENTS** for all long-running operations (>30 seconds) - Bash commands stop when context switches
- **TODOWRITE** for complex tasks (3+ steps) ‚Üí parallel agents ‚Üí git checkpoints ‚Üí test validation
- **READ FILES FIRST** before editing - Edit/Write tools will fail if you didn't read the file first
- **DEBT PREVENTION** - Before creating new files, check for existing similar functionality to extend  
- **SINGLE SOURCE OF TRUTH** - One authoritative implementation per feature/concept

### ‚ö° EXECUTION PATTERNS
- **PARALLEL TASK AGENTS** - Launch multiple Task agents simultaneously for maximum efficiency
- **SYSTEMATIC WORKFLOW** - TodoWrite ‚Üí Parallel agents ‚Üí Git checkpoints ‚Üí GitHub backup ‚Üí Test validation
- **GITHUB BACKUP WORKFLOW** - After every commit: `git push origin main` to maintain GitHub backup
- **BACKGROUND PROCESSING** - ONLY Task agents can run true background operations

### üîç MANDATORY PRE-TASK COMPLIANCE CHECK
> **STOP: Before starting any task, Claude Code must explicitly verify ALL points:**

**Step 1: Rule Acknowledgment**
- [ ] ‚úÖ I acknowledge all critical rules in CLAUDE.md and will follow them

**Step 2: Task Analysis**  
- [ ] Will this create files in root? ‚Üí If YES, use proper module structure instead
- [ ] Will this take >30 seconds? ‚Üí If YES, use Task agents not Bash
- [ ] Is this 3+ steps? ‚Üí If YES, use TodoWrite breakdown first
- [ ] Am I about to use grep/find/cat? ‚Üí If YES, use proper tools instead

**Step 3: Technical Debt Prevention (MANDATORY SEARCH FIRST)**
- [ ] **SEARCH FIRST**: Use Grep pattern="<functionality>.*<keyword>" to find existing implementations
- [ ] **CHECK EXISTING**: Read any found files to understand current functionality
- [ ] Does similar functionality already exist? ‚Üí If YES, extend existing code
- [ ] Am I creating a duplicate class/manager? ‚Üí If YES, consolidate instead
- [ ] Will this create multiple sources of truth? ‚Üí If YES, redesign approach
- [ ] Have I searched for existing implementations? ‚Üí Use Grep/Glob tools first
- [ ] Can I extend existing code instead of creating new? ‚Üí Prefer extension over creation
- [ ] Am I about to copy-paste code? ‚Üí Extract to shared utility instead

**Step 4: Session Management**
- [ ] Is this a long/complex task? ‚Üí If YES, plan context checkpoints
- [ ] Have I been working >1 hour? ‚Üí If YES, consider /compact or session break

> **‚ö†Ô∏è DO NOT PROCEED until all checkboxes are explicitly verified**

üèóÔ∏è PROJECT OVERVIEW - MINSPixhawk
üéØ PROJECT PURPOSE
MINSPixhawk ÊòØ‰∏ÄÂÄãÊï¥ÂêàÊ°ÜÊû∂ÔºåÊó®Âú®ËÆì Xsens MTi-680 È´òÁ≤æÂ∫¶ÊÑüÊ∏¨Âô® ÊàêÁÇ∫ Pixhawk (PX4) Ëá™‰∏ªÂ∞éËà™ÁöÑ‰∏ªË¶Å‰æÜÊ∫êÔºåÈÄèÈÅé MAVLink ÂçîÂÆöÂç≥ÊôÇÂÇ≥Ëº∏Ë≥áÊñôÔºåÂÆåÂÖ®ÊàñÈÉ®ÂàÜÂèñ‰ª£ PX4 ÂÖßÂª∫ IMU/GPS ÁöÑÂäüËÉΩ„ÄÇ

[üÜï] Êú¨Â∞àÊ°à‰∫¶Âº∑Ë™øÔºö

ÈñãÁôºÈöéÊÆµ‰∏≠ÂèØÈÄèÈÅé IDE Âç≥ÊôÇÁõ£ÊéßËº∏Âá∫Ë≥áÊñôÔºàÂ¶Ç MAVLink HeartbeatÔºâ

Êèê‰æõÁ≤æÁ¥∞ÊéßÂà∂‰∏≤ÂàóËßíËâ≤ÂàÜÂ∑•Ôºå‰∏¶Âä†ÂÖ•ÁãÄÊÖãÁõ£ÊéßÈªûÔºàCheckpointÔºâÊû∂ÊßãÔºåÂà©ÊñºÈåØË™§ËøΩËπ§ËàáÁ≥ªÁµ±Ê∏¨Ë©¶

üîß HARDWARE ARCHITECTURE
Arduino MCU with multiple UART ports:

SerialÔºöÈñãÁôºËÄÖËàá IDE Â∞çË©±‰ªãÈù¢ÔºåÁî®ÊñºÂëΩ‰ª§Ëº∏ÂÖ•Ëàá debug Ë≥áË®äËßÄÂØü

Serial1ÔºöÂ∞àÁî® Pixhawk ÂÇ≥Ëº∏ÈÄöÈÅìÔºàÁôºÈÄÅ MAVLink Ë≥áÊñôÔºâ

Serial2ÔºöXsens MTi-680 ÊÑüÊ∏¨Âô®‰∏≤ÂàóÈÄöË®äÔºàXBUS Ê®°ÂºèÔºåÂåÖÂê´ IMU ËàáÂÖßÂª∫ GNSS ÂäüËÉΩÔºâ

Serial3ÔºöÈ†êÁïô GNSS NMEA Ëº∏Âá∫ÔºàÁõÆÂâçÊú™‰ΩøÁî®Ôºâ

Serial4ÔºöÈ†êÁïô GNSS NMEA Ëº∏ÂÖ•ÔºàÁõÆÂâçÊú™‰ΩøÁî®Ôºâ

[üÜï] UART Ê®°ÂºèË®≠Ë®àÈÇèËºØÔºö

Xsens ÊÑüÊ∏¨Âô®ÂÖ∑ÂÇôÂÖßÂª∫ GNSS Ê®°ÁµÑÔºåÊâÄÊúâ GNSS Áõ∏ÈóúË≥áÊñôÔºàÂ¶ÇÁ∂ìÁ∑ØÂ∫¶„ÄÅÈÄüÂ∫¶„ÄÅFix ÁãÄÊÖãÔºâÁöÜÁî± Serial2 Êé•Êî∂ÁöÑ XBUS Â∞ÅÂåÖÊèê‰æõ

Á≥ªÁµ±ÁõÆÂâçÊú™‰ΩøÁî® Serial3 Êàñ Serial4 ÈÄ≤Ë°å‰ªª‰ΩïÂØ¶Èöõ GNSS Ë≥áÊñôÂÇ≥Ëº∏Ôºå‰ΩÜ‰øùÁïôËÖ≥‰ΩçÂÆöÁæ©‰ª•Âà©Êú™‰æÜÊì¥ÂÖÖ

ÈñãÁôºÊôÇÂèØÂ∞á Serial1 Ëá®ÊôÇÈÄ£Êé• USB-to-Serial Â∑•ÂÖ∑Ôºå‰ª•Áõ£ÁúãÂØ¶ÈöõÂÇ≥ÈÄÅ‰πã MAVLink Â∞ÅÂåÖÔºà‰æãÂ¶Ç‰ΩøÁî® RealTerm Êàñ SaleaeÔºâ

IDE ÂÉÖËÉΩËßÄÂØü Serial ÈÄöÈÅìÁöÑ debug Ëº∏Âá∫ÂÖßÂÆπ

[üÜï] Ê™¢Êü•ÈªûËº∏Âá∫ËàáÂ∞ÅÂåÖÁõ£Ê∏¨Ê†ºÂºè

Á≥ªÁµ±ÊñºÊØèÁ≠ÜÈóúÈçµË≥áÊñôÊµÅÔºàÂ¶Ç MAVLink„ÄÅXsens Â∞ÅÂåÖÔºâËôïË®≠ÁΩÆ„ÄåÊ™¢Êü•Èªû„ÄçÔºåËá™Âãï‰ª• HEX ÂΩ¢ÂºèËº∏Âá∫Â∞ÅÂåÖËá≥ IDE Serial Monitor

Ëº∏Âá∫Ê†ºÂºèÂ¶Ç‰∏ãÔºö

[HEARTBEAT] FE 09 23 01 01 00 00 00 ...
[ODOMETRY] FE 3C 2A 01 01 ...
[XSENS:LatLon] FA FF 32 01 ...
[XSENS:Quaternion] FA FF 21 02 ...

Âè™Ë¶Å IDE ÁöÑ USB Serial ÈÄ£Á∑öÂ≠òÂú®ÔºåÁ≥ªÁµ±Âç≥Ëá™ÂãïËº∏Âá∫ÊâÄÊúâÂ∞ÅÂåÖË≥áË®äÔºåÁÑ°ÈúÄÈ°çÂ§ñÂïüÁî® debug flag

ÈÄôÁ®ÆÊ†ºÂºèË®≠Ë®àÂèØÊñπ‰æøÈñãÁôºËÄÖÂø´ÈÄüÊØîÂ∞ç HEX ‰ΩçÂÖÉ„ÄÅÂ∞ÅÂåÖ ID ËàáÈÄöË®äÁµêÊßãÔºå‰∏¶Áî®ÊñºÊú™‰æÜÊó•Ë™åÊØîÂ∞çËàáËá™ÂãïÊ∏¨Ë©¶ÂàÜÊûê[üÜï] ‚úÖ Êñ∞Â¢ûË®∫Êñ∑ËàáË≥áÊñôÊ™¢Êü•ÈªûÁ≥ªÁµ±

Á≥ªÁµ±‰∏≠ÊØèÂÄãÈóúÈçµËôïÁêÜÊ≠•È©üÔºàÂ¶Ç Xsens Ê†°Ê≠£ÂÆåÊàê„ÄÅMAVLink Â∞ÅË£ùÂæå„ÄÅGPS ËΩâÊèõÂâçÔºâÁöÜË®≠ÁΩÆ checkpointÔºåÂèØËº∏Âá∫Ëá≥ Serial ‰æõ debug

HEARTBEAT ÊîØÊè¥ÂêåÊ≠•Ëº∏Âá∫Ëá≥ Serial Êñπ‰æøÂú® IDE ‰∏≠ÂêåÊ≠•ËßÄÂØü

üß© MODULE STRUCTURE
bash
Copy
Edit
src/main/cpp/
‚îú‚îÄ‚îÄ core/           # Ê†∏ÂøÉÊµÅÁ®ãËàáÊ®°ÂºèËΩâÊèõÈÇèËºØ
‚îú‚îÄ‚îÄ sensors/        # ÊÑüÊ∏¨Âô®ÔºàXsensÔºâË≥áÊñôËÆÄÂèñËàáÊ†ºÂºèËß£Êûê
‚îú‚îÄ‚îÄ mavlink/        # MAVLink Ë≥áÊñôÂ∞ÅË£ùËàáÁôºÈÄÅÈÇèËºØ
‚îú‚îÄ‚îÄ utils/          # Êï∏Â≠∏ËôïÁêÜÔºàÂ∫ßÊ®ô„ÄÅÂõõÂÖÉÊï∏„ÄÅDCMÔºâ
‚îú‚îÄ‚îÄ models/         # Ë≥áÊñôÁµêÊßãÂÆöÁæ©ÔºàIMU frame, GPS frame Á≠âÔºâ
‚îú‚îÄ‚îÄ services/       # ÂàùÂßãÂåñÊµÅÁ®ã„ÄÅÁãÄÊÖãÊ©ü„ÄÅLED ÊåáÁ§∫ÈÇèËºØ
‚îî‚îÄ‚îÄ api/            # Serial ÂëΩ‰ª§Êé•Êî∂Ëàá USB ÈÄöË®ä‰ªãÈù¢
üéØ DEVELOPMENT STATUS
Setup: ‚úÖ ÂÆåÊàê (Â§ö UART ÂàùÂßãÂåñ„ÄÅXsens handshake)

Core Features: üîÑ ÈñãÁôº‰∏≠ÔºàÂê´ output_mode ÂàáÊèõÊ©üÂà∂Ôºâ

Testing: ‚è≥ Ê∏¨Ë©¶Ë¶èÂäÉËàáÈÇèËºØÂàÜÊûêÂÑÄÊØîÂ∞çÂêåÊ≠•ÈñãÁôº‰∏≠

Documentation: üîÑ ÊåÅÁ∫åÊõ¥Êñ∞ÔºàÂê´ FSM ÁãÄÊÖãÊ©üËàáËá™ÂãïÂåñÊ™¢Êü•ÈªûË®≠Ë®àÔºâ

üìã MINSPIXHAWK-SPECIFIC DEVELOPMENT GUIDELINES
üîß C++/Arduino ÁâπÂÆöË¶èÁØÑ
.h Ê™îÊ°àË´ãÁΩÆÊñºÊ®°ÁµÑÁõÆÈåÑ‰∏≠Ôºå‰∏çÂèØÂπ≥Ë°åÊîæÁΩÆÊñºÊ†πÁõÆÈåÑ

ÊâÄÊúâ Quaternion, DCM Ë´ãÁΩÆÊñº namespace MyQuaternion or MyDirectCosineMatrix ‰∏ãÔºåÁµ±‰∏Ä‰ΩøÁî®

ÂµåÂÖ•ÂºèÁ≥ªÁµ±Ë´ãÈÅøÂÖçÂãïÊÖãË®òÊÜ∂È´îÈÖçÁΩÆÔºànew, mallocÔºâÔºåÂÑ™ÂÖàÊé°Áî®ÈùúÊÖã buffer ÊàñÂÖ®ÂüüËÆäÊï∏

[üÜï] Êñ∞Â¢ûÊ®°ÂºèÂàáÊèõÂª∫Ë≠∞Ôºö

ÊØèÊ¨°ÈñãÊ©üÈ†êË®≠ÈÄ≤ÂÖ• OUT_MODE_CONFIG Ê®°Âºè ‚Üí Ê™¢Êü• Xsens ÂàùÂßãÂåñÊµÅÁ®ã„ÄÅÁãÄÊÖãÊòØÂê¶ÊàêÂäü

ÊàêÂäüÂæåÈÄ≤ÂÖ• OUT_MODE_MAVLINK Á≠âË≥áÊñôÊµÅÈÄöÊ®°Âºè

üß™ TESTING APPROACH
[üÜï] ‚úÖ Êú¨Â∞àÊ°àÂº∑ÂåñÊ∏¨Ë©¶ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö

Ê∏¨Ë©¶È°ûÂûã	ÊñπÊ≥ï	Â∑•ÂÖ∑
Unit Ê∏¨Ë©¶	Ê®°ÁµÑÂÖßÂõûÂÇ≥ÂÄºÊØîÂ∞ç	Arduino assert() / Ê®°Êì¨Ë≥áÊñôÂ∞ÅË£ù
Integration Ê∏¨Ë©¶	ÂêÑÊ®°ÁµÑÈñì data flow Ê∏¨Ë©¶	Serial output Â∞çÁÖß PX4 log
HIL Ê∏¨Ë©¶	ÂØ¶È´î Xsens ‚Üí MCU ‚Üí Pixhawk ‚Üí QGC	Logic Analyzer / MAVLink Inspector
Debug Ê™¢Êü•Èªû	ÊØèÈöéÊÆµ Serial.print() Ê™¢Êü•	IDE Serial Monitor + ‰∫§ÂèâÁ∑®Á¢ºÊ®ôË®ò
Heartbeat È©óË≠â	HEARTBEAT ÂêåÊ≠• echo Âà∞ Serial	ËßÄÂØü IDE Ëàá QGC ÊòØÂê¶ÂêåÊ≠•Êõ¥Êñ∞

## üéØ RULE COMPLIANCE CHECK

Before starting ANY task, verify:
- [ ] ‚úÖ I acknowledge all critical rules above
- [ ] Files go in proper module structure (src/main/cpp/)
- [ ] Use Task agents for >30 second operations
- [ ] TodoWrite for 3+ step tasks
- [ ] Commit after each completed task
- [ ] Push to GitHub after every commit

## üöÄ COMMON COMMANDS

```bash
# Build project (when build system is configured)
# make build

# Upload to Arduino (when configured)
# make upload

# Run tests (when test framework is configured)
# make test

# Monitor serial output
# make monitor
```

## üö® TECHNICAL DEBT PREVENTION

### ‚ùå WRONG APPROACH (Creates Technical Debt):
```bash
# Creating new file without searching first
Write(file_path="new_sensor_v2.cpp", content="...")
```

### ‚úÖ CORRECT APPROACH (Prevents Technical Debt):
```bash
# 1. SEARCH FIRST
Grep(pattern="sensor.*implementation", include="*.cpp")
# 2. READ EXISTING FILES  
Read(file_path="src/main/cpp/sensors/xsens_sensor.cpp")
# 3. EXTEND EXISTING FUNCTIONALITY
Edit(file_path="src/main/cpp/sensors/xsens_sensor.cpp", old_string="...", new_string="...")
```

---

**‚ö†Ô∏è Prevention is better than consolidation - build clean from the start.**  
**üéØ Focus on single source of truth and extending existing functionality.**  
**üìà Each task should maintain clean architecture and prevent technical debt.**